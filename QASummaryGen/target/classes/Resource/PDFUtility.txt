package com.qasummarygen.utils;

import java.awt.Color;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;

import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.pdmodel.PDPage;
import org.apache.pdfbox.pdmodel.common.PDRectangle;
import org.apache.pdfbox.pdmodel.font.PDType1Font;

import com.lowagie.text.Anchor;
import com.lowagie.text.Chunk;
import com.lowagie.text.Document;
import com.lowagie.text.DocumentException;
import com.lowagie.text.Font;
import com.lowagie.text.FontFactory;
import com.lowagie.text.Paragraph;

import org.apache.pdfbox.pdmodel.PDPageContentStream;

import be.quodlibet.boxable.BaseTable;
import be.quodlibet.boxable.Cell;
import be.quodlibet.boxable.HorizontalAlignment;
import be.quodlibet.boxable.Row;

public class PDFReportUtility {

    public static void generatePDFReport(QASummary summary, String outputFilePath) throws IOException {
        PDDocument document = new PDDocument();
        PDPage page = new PDPage(PDRectangle.A4);
        document.addPage(page);

        float margin = 50;
        PDRectangle pageSize = page.getMediaBox();
        float yStart = pageSize.getHeight() - margin;
        float tableWidth = pageSize.getWidth() - (2 * margin);
        float yPosition = yStart;

        // Add description
        addDescription(document, page, margin, yPosition, ReportChartUtility.getStaticReportDescription());
        yPosition -= 80;

        BaseTable table = new BaseTable(yPosition, yStart, margin, tableWidth, margin, document, page, true, true);

        addHeaderRow(table, "QA Summary Report");
        addProjectDetails(table, summary);
        addTestCaseMetrics(table, summary);
        addBugMetrics(table, summary);
        addQualityMetrics(table, summary);
        addSuggestions(table, summary.getSuggestions());
        addFooter(table, summary.getGeneratedBy());

        table.draw();

        // âœ… Save document at the end
        saveDocument(document, outputFilePath);
    }

    private static void addHeaderRow(BaseTable table, String title) {
        Row<PDPage> headerRow = table.createRow(20);
        Cell<PDPage> headerCell = headerRow.createCell(100, title);
        headerCell.setFont(PDType1Font.HELVETICA_BOLD);
        headerCell.setFontSize(16);
        headerCell.setFillColor(new Color(173, 216, 230));
        headerCell.setAlign(HorizontalAlignment.CENTER);
        table.addHeaderRow(headerRow);
    }

    private static void addProjectDetails(BaseTable table, QASummary summary) {
        addRow(table, "Project Name", summary.getProjectName());
        addRow(table, "Sprint Name", summary.getSprintName());
        addRow(table, "Sprint Start Date", summary.getSprintStartDate());	
	addRow(table, "Sprint End Date", summary.getSprintStartDate());
    }

    private static void addTestCaseMetrics(BaseTable table, QASummary summary) {
        addRow(table, "Total Test Cases", String.valueOf(summary.getTotalTestCases()));
        addRow(table, "Automated Test Cases", String.valueOf(summary.getAutomatedTestCases()));
        addRow(table, "Manual Test Cases", String.valueOf(summary.getManualTestCases()));
        addRow(table, "Stories Delivered", String.valueOf(summary.getTotalStoriesDelivered()));
    }

    private static void addBugMetrics(BaseTable table, QASummary summary) {
        addRow(table, "Total Bugs", String.valueOf(summary.getTotalBugs()));
        addRow(table, "Critical Bugs", String.valueOf(summary.getCriticalBugs()));
        addRow(table, "Major Bugs", String.valueOf(summary.getMajorBugs()));
        addRow(table, "Minor Bugs", String.valueOf(summary.getMinorBugs()));
    }

    private static void addQualityMetrics(BaseTable table, QASummary summary) {
        addRow(table, "Test Coverage (%)", String.format("%.2f", summary.getTestCoverage()));
        addRow(table, "Bug Density", String.format("%.2f", summary.getBugDensity()));
        addRow(table, "Sprint Velocity", String.valueOf(summary.getSprintVelocity()));
    }

    private static void addSuggestions(BaseTable table, List<String> suggestions) {
        if (suggestions != null && !suggestions.isEmpty()) {
            for (int i = 0; i < suggestions.size(); i++) {
                addRow(table, "Suggestion " + (i + 1), suggestions.get(i));
            }
        }
    }

    private static void addFooter(BaseTable table, String generatedBy) {
        String now = LocalDateTime.now().format(DateTimeFormatter.ofPattern("dd-MM-yyyy HH:mm:ss"));
        addRow(table, "Generated On", now);
        addRow(table, "Generated By", generatedBy);
    }

    private static void addRow(BaseTable table, String key, String value) {
        Row<PDPage> row = table.createRow(16);
        Cell<PDPage> cell1 = row.createCell(30, key);
        Cell<PDPage> cell2 = row.createCell(70, value);

        cell1.setFont(PDType1Font.HELVETICA_BOLD);
        cell2.setFont(PDType1Font.HELVETICA);
        cell1.setFontSize(11);
        cell2.setFontSize(11);
    }

    public static void addDescription(PDDocument document, PDPage page, float margin, float yPosition, String descriptionText) throws IOException {
        PDPageContentStream contentStream = new PDPageContentStream(document, page, PDPageContentStream.AppendMode.APPEND, true, true);

        String heading = "Report Description:";
        PDType1Font boldFont = PDType1Font.HELVETICA_BOLD;
        PDType1Font regularFont = PDType1Font.HELVETICA;
        int headingFontSize = 12;
        int fontSize = 11;
        float leading = 1.5f * fontSize;
        float width = PDRectangle.A4.getWidth() - 2 * margin;
        float textY = yPosition;

        contentStream.beginText();
        contentStream.setFont(boldFont, headingFontSize);
        contentStream.newLineAtOffset(margin, textY);
        contentStream.showText(heading);
        contentStream.endText();

        List<String> lines = getWrappedLines(descriptionText, regularFont, fontSize, width);
        textY -= leading;

        for (String line : lines) {
            contentStream.beginText();
            contentStream.setFont(regularFont, fontSize);
            contentStream.newLineAtOffset(margin, textY);
            contentStream.showText(line);
            contentStream.endText();
            textY -= leading;
        }

        contentStream.close();
    }

    private static List<String> getWrappedLines(String text, PDType1Font font, int fontSize, float maxWidth) throws IOException {
        List<String> lines = new ArrayList<>();
        StringBuilder currentLine = new StringBuilder();

        for (String word : text.split(" ")) {
            String testLine = currentLine.length() == 0 ? word : currentLine + " " + word;
            float textWidth = font.getStringWidth(testLine) / 1000 * fontSize;

            if (textWidth > maxWidth) {
                lines.add(currentLine.toString());
                currentLine = new StringBuilder(word);
            } else {
                currentLine = new StringBuilder(testLine);
            }
        }

        if (currentLine.length() > 0) {
            lines.add(currentLine.toString());
        }

        return lines;
    }

    private static void saveDocument(PDDocument document, String outputFilePath) throws IOException {
        File file = new File(outputFilePath);
        try (FileOutputStream fos = new FileOutputStream(file)) {
            document.save(fos);
        } finally {
            document.close();
        }
        System.out.println("âœ… PDF report generated successfully: " + file.getAbsolutePath());
    }
    
 // This part is for quick links: 
    private static void addQuickLinks(Document document) throws DocumentException {
        Font titleFont = FontFactory.getFont(FontFactory.HELVETICA_BOLD, 14, Color.BLACK);
        Font linkFont = FontFactory.getFont(FontFactory.HELVETICA, 12, Color.BLUE);

        // Title
        Paragraph title = new Paragraph("ðŸ“˜ Quick Links", titleFont);
        title.setSpacingAfter(10f);
        document.add(title);

        // Link 1
        Anchor confluenceLink = new Anchor("ðŸ”— Release Confluence Page", linkFont);
        confluenceLink.setReference("https://your-confluence-url");
        document.add(confluenceLink);
        document.add(Chunk.NEWLINE);

        // Link 2
        Anchor jiraBoardLink = new Anchor("ðŸ”— JIRA Board", linkFont);
        jiraBoardLink.setReference("https://your-jira-board-url");
        document.add(jiraBoardLink);
        document.add(Chunk.NEWLINE);

        // Link 3
        Anchor xrayLink = new Anchor("ðŸ”— JIRA XRay Report", linkFont);
        xrayLink.setReference("https://your-jira-xray-url");
        document.add(xrayLink);
        document.add(Chunk.NEWLINE);

        // Space before description
        document.add(Chunk.NEWLINE);
    
}
}